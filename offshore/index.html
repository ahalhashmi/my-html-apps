<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UAE Offshore Tracker (Stable Controls)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.wms@0.1.1/dist/leaflet.wms.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --bar:#111827;
      --bar2:#0f172a;
      --ink:#eaf0ff;
      --muted:#b8c6e6;
      --btn:#2d6cdf;
      --btn2:#2a2f3a;
      --danger:#b63a3a;
      --radius:14px;
      --barH: 210px; /* control bar height */
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

    /* Layout: map area + bottom control bar */
    .app{height:100%; display:flex; flex-direction:column;}
    #map{flex:1; min-height: 200px;}

    .bar{
      height: var(--barH);
      background: linear-gradient(180deg, var(--bar2), var(--bar));
      border-top: 1px solid rgba(255,255,255,0.10);
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      box-sizing: border-box;
    }

    .title{font-weight:800; font-size:16px; margin-bottom:8px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px;}

    label{display:flex; gap:8px; align-items:center; user-select:none; font-size:14px;}
    input[type="checkbox"]{transform: scale(1.1);}

    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      background: rgba(0,0,0,0.25); color: var(--muted); font-size:12px;
    }

    button{
      border:0; border-radius:12px; padding:10px 12px;
      font-weight:800; background:var(--btn); color:white;
      font-size:14px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    button.secondary{ background:var(--btn2); }
    button.danger{ background:var(--danger); }

    .status{
      font-size:12px; color:var(--muted); line-height:1.35;
      background: rgba(0,0,0,0.20);
      padding: 10px; border-radius: 12px;
      max-height: 70px; overflow:auto;
    }

    /* Simple toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(var(--barH) + 18px);
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 800;
      z-index: 999999;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      max-width: 92vw;
      text-align: center;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>

<body>
  <div class="app">
    <div id="map"></div>

    <div class="bar">
      <div class="title">UAE Offshore Tracker (Stable Controls)</div>

      <div class="row">
        <label><input id="seamarks" type="checkbox" checked> Seamarks</label>
        <label><input id="gebco" type="checkbox" checked> Bathymetry</label>
        <span class="pill" id="gpsPill">GPS: OFF</span>
        <span class="pill" id="trkPill">TRACK: OFF</span>
      </div>

      <div class="row">
        <!-- Inline onclick is a fallback in case addEventListener is blocked -->
        <button id="testBtn" class="secondary" onclick="window.__btnTest && window.__btnTest()">Test Button</button>
        <button id="gpsBtn" onclick="window.__gpsToggle && window.__gpsToggle()">Start GPS</button>
        <button id="centerBtn" class="secondary" onclick="window.__center && window.__center()">Center</button>
        <button id="trackBtn" class="secondary" onclick="window.__trackToggle && window.__trackToggle()">Start Tracking</button>
        <button id="saveBtn" class="secondary" onclick="window.__save && window.__save()">Save Session</button>
        <button id="clearBtn" class="danger" onclick="window.__clear && window.__clear()">Clear</button>
      </div>

      <div class="status" id="status">
        Tap <b>Test Button</b>. If you see a toast, buttons are working.
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Buttons are working ✅</div>

  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const toast = $("toast");
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1200);
      if (navigator.vibrate) navigator.vibrate(50);
    }
    function setStatus(html){ $("status").innerHTML = html; }
    function setPill(id, on, label){
      const el = $(id);
      el.textContent = `${label}: ${on ? "ON" : "OFF"}`;
      el.style.background = on ? "rgba(26,127,58,0.35)" : "rgba(0,0,0,0.25)";
      el.style.color = on ? "#dfffe7" : "#b8c6e6";
    }

    // ---------- Map ----------
    const UAE_GULF_BOUNDS = L.latLngBounds([23.0, 50.0], [27.8, 56.8]);

    const map = L.map('map', {
      zoomControl: true,
      maxBounds: UAE_GULF_BOUNDS.pad(0.15),
      maxBoundsViscosity: 0.8
    });
    map.fitBounds(UAE_GULF_BOUNDS);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const openSeaMarks = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
      maxZoom: 18, opacity: 0.95, attribution: 'Seamarks &copy; OpenSeaMap'
    }).addTo(map);

    const gebcoWms = L.WMS.overlay('https://wms.gebco.net/mapserv?', {
      layers: 'GEBCO_LATEST',
      format: 'image/png',
      transparent: true,
      opacity: 0.65,
      attribution: 'Bathymetry &copy; GEBCO'
    }).addTo(map);

    $("seamarks").addEventListener("change", (e) => {
      e.target.checked ? map.addLayer(openSeaMarks) : map.removeLayer(openSeaMarks);
      showToast("Seamarks toggled ✅");
    });
    $("gebco").addEventListener("change", (e) => {
      e.target.checked ? map.addLayer(gebcoWms) : map.removeLayer(gebcoWms);
      showToast("Bathymetry toggled ✅");
    });

    // ---------- GPS + Tracking ----------
    let watchId = null;
    let lastFix = null;

    let gpsMarker = null;
    let gpsAccCircle = null;

    let isTracking = false;
    let trackPoints = [];
    let trackLine = null;

    const STORE_KEY = "uae_offshore_track_sessions_v1";

    function drawGPS(fix){
      const ll = L.latLng(fix.lat, fix.lng);

      if (!gpsMarker) gpsMarker = L.circleMarker(ll, { radius: 7, weight: 2, fillOpacity: 0.9 }).addTo(map);
      else gpsMarker.setLatLng(ll);

      if (!gpsAccCircle) gpsAccCircle = L.circle(ll, { radius: fix.acc || 0, weight: 1, fillOpacity: 0.12 }).addTo(map);
      else { gpsAccCircle.setLatLng(ll); gpsAccCircle.setRadius(fix.acc || 0); }
    }

    function ensureTrackLine(){
      if (!trackLine) trackLine = L.polyline([], { weight: 4, opacity: 0.9 }).addTo(map);
    }

    function shouldAppendPoint(prev, next){
      if (!prev) return true;
      if ((next.acc || 9999) > 50) return false;

      const distM = map.distance([prev.lat, prev.lng], [next.lat, next.lng]);
      const dtMs = (next.ts - prev.ts);

      const moving = (next.speed || 0) > 0.6; // ~2.2 km/h
      const distThresh = moving ? 8 : 15;     // meters
      const timeThresh = 8000;                // 8 sec

      return distM >= distThresh || dtMs >= timeThresh;
    }

    function onPosSuccess(pos){
      const c = pos.coords;
      const fix = {
        lat: c.latitude,
        lng: c.longitude,
        acc: c.accuracy ?? null,
        speed: c.speed ?? null,
        heading: c.heading ?? null,
        ts: pos.timestamp || Date.now()
      };
      lastFix = fix;
      drawGPS(fix);

      if (isTracking){
        const prev = trackPoints.length ? trackPoints[trackPoints.length - 1] : null;
        if (shouldAppendPoint(prev, fix)){
          trackPoints.push(fix);
          ensureTrackLine();
          trackLine.addLatLng([fix.lat, fix.lng]);
        }
      }

      setStatus(
        `<b>GPS ON</b> • ${new Date(fix.ts).toLocaleTimeString()}<br>` +
        `Lat ${fix.lat.toFixed(6)} • Lng ${fix.lng.toFixed(6)} • Acc ~${Math.round(fix.acc || 0)}m` +
        (isTracking ? `<br><b>Tracking…</b> Points: ${trackPoints.length}` : "")
      );
    }

    function onPosError(err){
      stopGPS();
      setStatus(
        `<b>GPS error</b>: ${err.message || err}<br>` +
        `Make sure you open this on <b>HTTPS</b> and Safari location is allowed.`
      );
      showToast("GPS error ❌");
    }

    function startGPS(){
      if (!navigator.geolocation){
        setStatus("Geolocation not supported.");
        showToast("No geolocation ❌");
        return;
      }
      if (location.protocol === "file:"){
        setStatus("Open from <b>HTTPS</b> (not file://) to allow GPS permissions.");
        showToast("Use HTTPS ❌");
        return;
      }
      if (!window.isSecureContext){
        setStatus("Not a secure context. Use <b>HTTPS</b> (or localhost).");
        showToast("Use HTTPS ❌");
        return;
      }

      setStatus("Requesting GPS permission…");
      watchId = navigator.geolocation.watchPosition(onPosSuccess, onPosError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 12000
      });

      $("gpsBtn").textContent = "Stop GPS";
      setPill("gpsPill", true, "GPS");
      showToast("GPS started ✅");
    }

    function stopGPS(){
      if (watchId !== null){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (isTracking) stopTracking();

      if (gpsMarker){ map.removeLayer(gpsMarker); gpsMarker = null; }
      if (gpsAccCircle){ map.removeLayer(gpsAccCircle); gpsAccCircle = null; }

      lastFix = null;
      $("gpsBtn").textContent = "Start GPS";
      setPill("gpsPill", false, "GPS");
      setStatus("GPS OFF.");
    }

    function toggleGPS(){ watchId === null ? startGPS() : stopGPS(); }

    function centerOnMe(){
      if (!lastFix){
        setStatus("No GPS fix yet. Start GPS first.");
        showToast("No fix ⚠️");
        return;
      }
      map.setView([lastFix.lat, lastFix.lng], Math.max(map.getZoom(), 12));
      showToast("Centered ✅");
    }

    function startTracking(){
      if (watchId === null){
        setStatus("Start GPS first, then start tracking.");
        showToast("Start GPS first ⚠️");
        return;
      }
      isTracking = true;
      setPill("trkPill", true, "TRACK");
      $("trackBtn").textContent = "Stop Tracking";
      $("trackBtn").classList.remove("secondary");
      ensureTrackLine();

      if (lastFix && trackPoints.length === 0){
        trackPoints.push(lastFix);
        trackLine.addLatLng([lastFix.lat, lastFix.lng]);
      }

      setStatus(`Tracking started… Points: ${trackPoints.length}`);
      showToast("Tracking started ✅");
    }

    function stopTracking(){
      isTracking = false;
      setPill("trkPill", false, "TRACK");
      $("trackBtn").textContent = "Start Tracking";
      $("trackBtn").classList.add("secondary");
      setStatus(`Tracking stopped. Points: ${trackPoints.length}`);
      showToast("Tracking stopped");
    }

    function toggleTracking(){ isTracking ? stopTracking() : startTracking(); }

    function clearAll(){
      if (isTracking) stopTracking();
      trackPoints = [];
      if (trackLine){ map.removeLayer(trackLine); trackLine = null; }
      setStatus("Cleared current track (saved sessions remain).");
      showToast("Cleared ✅");
    }

    function loadSessions(){
      try { return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
      catch { return []; }
    }
    function saveSessions(list){
      localStorage.setItem(STORE_KEY, JSON.stringify(list));
    }

    function saveCurrentSession(){
      if (trackPoints.length < 2){
        setStatus("Need at least 2 points to save. Start tracking and move.");
        showToast("Not enough points ⚠️");
        return;
      }

      let dist = 0;
      for (let i=1; i<trackPoints.length; i++){
        dist += map.distance(
          [trackPoints[i-1].lat, trackPoints[i-1].lng],
          [trackPoints[i].lat, trackPoints[i].lng]
        );
      }

      const startTs = trackPoints[0].ts;
      const session = {
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2)),
        name: `Session ${new Date(startTs).toLocaleString()}`,
        createdAt: Date.now(),
        points: trackPoints,
        distanceM: Math.round(dist)
      };

      const sessions = loadSessions();
      sessions.unshift(session);
      saveSessions(sessions);

      setStatus(`✅ Saved: <b>${session.name}</b> • ${session.points.length} pts • ~${session.distanceM} m`);
      showToast("Saved ✅");
    }

    // ---------- Button wiring (both addEventListener + inline fallback already present) ----------
    function btnTest(){
      showToast("Buttons are working ✅");
      setStatus("Test OK ✅ Bottom bar buttons are clickable.");
      alert("Buttons are working ✅"); // extra-strong proof
    }

    // Expose functions for inline onclick fallback
    window.__btnTest = btnTest;
    window.__gpsToggle = toggleGPS;
    window.__center = centerOnMe;
    window.__trackToggle = toggleTracking;
    window.__save = saveCurrentSession;
    window.__clear = clearAll;

    // Also wire via addEventListener
    $("testBtn").addEventListener("click", btnTest);
    $("gpsBtn").addEventListener("click", toggleGPS);
    $("centerBtn").addEventListener("click", centerOnMe);
    $("trackBtn").addEventListener("click", toggleTracking);
    $("saveBtn").addEventListener("click", saveCurrentSession);
    $("clearBtn").addEventListener("click", clearAll);

    // init pills
    setPill("gpsPill", false, "GPS");
    setPill("trkPill", false, "TRACK");
  </script>
</body>
</html>
