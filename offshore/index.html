<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UAE Offshore Tracker (Prototype)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.wms@0.1.1/dist/leaflet.wms.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    :root{
      --chip:#111a; --ink:#fff; --muted:#cfe0ffcc;
      --btn:#2d6cdf; --btn2:#2a2f3a; --danger:#b63a3a;
      --radius:14px;
    }

    /* IMPORTANT: ensure overlay receives taps on mobile */
    .panel{
      position: absolute;
      z-index: 9999;
      left: 10px;
      top: 10px;
      background: var(--chip);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: var(--radius);
      backdrop-filter: blur(8px);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      max-width: 94vw;

      pointer-events: auto;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }

    /* Leaflet controls can sit above if z-index isn't high enough on iOS */
    .leaflet-top, .leaflet-bottom { z-index: 5000; }

    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label{ display:flex; gap:8px; align-items:center; user-select:none; }

    button{
      border:0; border-radius:12px; padding:10px 10px;
      font-weight:700; background:var(--btn); color:white;
      pointer-events: auto;
      touch-action: manipulation;
    }
    button.secondary{ background:var(--btn2); }
    button.danger{ background:var(--danger); }

    .small{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35; }
    .pill{
      display:inline-block; padding:3px 8px; border-radius:999px;
      background:#0003; font-size:12px; color:var(--muted);
    }

    /* Toast notification */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-weight: 700;
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      max-width: 92vw;
      text-align: center;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel" id="panel">
    <div style="font-weight:800; margin-bottom:6px;">UAE Offshore Tracker</div>

    <div class="row" style="margin-bottom:6px;">
      <label><input id="seamarks" type="checkbox" checked> Seamarks</label>
      <label><input id="gebco" type="checkbox" checked> Bathymetry</label>
      <span class="pill" id="gpsPill">GPS: OFF</span>
      <span class="pill" id="trkPill">TRACK: OFF</span>
    </div>

    <div class="row">
      <button id="testBtn" class="secondary">Test Button</button>
      <button id="gpsBtn">Start GPS</button>
      <button id="centerBtn" class="secondary">Center</button>
      <button id="trackBtn" class="secondary">Start Tracking</button>
      <button id="saveBtn" class="secondary">Save Session</button>
      <button id="clearBtn" class="danger">Clear</button>
    </div>

    <div class="small" id="status">
      Tap “Test Button” first. If it works, you’ll see a toast + vibration (if supported).
    </div>
  </div>

  <div class="toast" id="toast">Buttons are working ✅</div>

  <script>
    // --- Map ---
    const UAE_GULF_BOUNDS = L.latLngBounds([23.0, 50.0], [27.8, 56.8]);

    const map = L.map('map', {
      zoomControl: true,
      maxBounds: UAE_GULF_BOUNDS.pad(0.15),
      maxBoundsViscosity: 0.8
    });
    map.fitBounds(UAE_GULF_BOUNDS);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const openSeaMarks = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
      maxZoom: 18, opacity: 0.95, attribution: 'Seamarks &copy; OpenSeaMap'
    }).addTo(map);

    const gebcoWms = L.WMS.overlay('https://wms.gebco.net/mapserv?', {
      layers: 'GEBCO_LATEST',
      format: 'image/png',
      transparent: true,
      opacity: 0.65,
      attribution: 'Bathymetry &copy; GEBCO'
    }).addTo(map);

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);
    const gpsPill = $("gpsPill");
    const trkPill = $("trkPill");
    const toast = $("toast");

    function setStatus(msg){ $("status").innerHTML = msg; }

    function setPill(el, on, label){
      el.textContent = `${label}: ${on ? "ON" : "OFF"}`;
      el.style.background = on ? "#1a7f3a55" : "#0003";
      el.style.color = on ? "#dfffe7" : "#cfe0ffcc";
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1200);
      if (navigator.vibrate) navigator.vibrate(60);
    }

    // IMPORTANT: prevent map from stealing taps intended for the panel (iOS Safari)
    // Stop pointer/touch events from propagating to Leaflet when interacting with the panel.
    const panel = $("panel");
    ["click","dblclick","mousedown","mouseup","touchstart","touchend","touchmove","pointerdown","pointerup","pointermove"].forEach(evt => {
      panel.addEventListener(evt, (e) => {
        e.stopPropagation();
      }, { passive: false });
    });

    // Layer toggles
    $("seamarks").addEventListener("change", (e) => {
      e.target.checked ? map.addLayer(openSeaMarks) : map.removeLayer(openSeaMarks);
      showToast("Layer toggled ✅");
    });

    $("gebco").addEventListener("change", (e) => {
      e.target.checked ? map.addLayer(gebcoWms) : map.removeLayer(gebcoWms);
      showToast("Layer toggled ✅");
    });

    // ---- GPS + Tracking state (same as before, but with visible toast feedback) ----
    let watchId = null;
    let lastFix = null;
    let gpsMarker = null;
    let gpsAccCircle = null;

    let isTracking = false;
    let trackPoints = [];
    let trackLine = null;

    const STORE_KEY = "uae_offshore_track_sessions_v1";

    function drawGPS(fix){
      const ll = L.latLng(fix.lat, fix.lng);

      if (!gpsMarker) gpsMarker = L.circleMarker(ll, { radius: 7, weight: 2, fillOpacity: 0.9 }).addTo(map);
      else gpsMarker.setLatLng(ll);

      if (!gpsAccCircle) gpsAccCircle = L.circle(ll, { radius: fix.acc || 0, weight: 1, fillOpacity: 0.12 }).addTo(map);
      else { gpsAccCircle.setLatLng(ll); gpsAccCircle.setRadius(fix.acc || 0); }
    }

    function ensureTrackLine(){
      if (!trackLine) trackLine = L.polyline([], { weight: 4, opacity: 0.9 }).addTo(map);
    }

    function shouldAppendPoint(prev, next){
      if (!prev) return true;
      if ((next.acc || 9999) > 50) return false;
      const distM = map.distance([prev.lat, prev.lng], [next.lat, next.lng]);
      const dtMs = (next.ts - prev.ts);
      const moving = (next.speed || 0) > 0.6;
      const distThresh = moving ? 8 : 15;
      const timeThresh = 8000;
      return distM >= distThresh || dtMs >= timeThresh;
    }

    function onPosSuccess(pos){
      const c = pos.coords;
      const fix = {
        lat: c.latitude,
        lng: c.longitude,
        acc: c.accuracy ?? null,
        speed: c.speed ?? null,
        heading: c.heading ?? null,
        ts: pos.timestamp || Date.now()
      };
      lastFix = fix;
      drawGPS(fix);

      if (isTracking){
        const prev = trackPoints.length ? trackPoints[trackPoints.length - 1] : null;
        if (shouldAppendPoint(prev, fix)){
          trackPoints.push(fix);
          ensureTrackLine();
          trackLine.addLatLng([fix.lat, fix.lng]);
        }
      }

      setStatus(
        `<b>GPS ON</b> • ${new Date(fix.ts).toLocaleTimeString()}<br>` +
        `Lat ${fix.lat.toFixed(6)} • Lng ${fix.lng.toFixed(6)} • Acc ~${Math.round(fix.acc || 0)}m` +
        (isTracking ? `<br><b>Tracking…</b> Points: ${trackPoints.length}` : "")
      );
    }

    function onPosError(err){
      stopGPS();
      setStatus(
        `<b>GPS error</b>: ${err.message || err}<br>` +
        `Make sure this is opened on <b>HTTPS</b> and Safari location is allowed.`
      );
      showToast("GPS error ❌");
    }

    function startGPS(){
      if (!navigator.geolocation){
        setStatus("Geolocation not supported.");
        showToast("No geolocation ❌");
        return;
      }
      if (location.protocol === "file:"){
        setStatus("Open from <b>HTTPS</b> (not file://) to allow GPS permissions.");
        showToast("Use HTTPS ❌");
        return;
      }
      if (!window.isSecureContext){
        setStatus("Not a secure context. Use <b>HTTPS</b> (or localhost).");
        showToast("Use HTTPS ❌");
        return;
      }

      setStatus("Requesting GPS permission…");
      watchId = navigator.geolocation.watchPosition(onPosSuccess, onPosError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 12000
      });

      $("gpsBtn").textContent = "Stop GPS";
      setPill(gpsPill, true, "GPS");
      showToast("GPS started ✅");
    }

    function stopGPS(){
      if (watchId !== null){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      if (isTracking) stopTracking();

      if (gpsMarker){ map.removeLayer(gpsMarker); gpsMarker = null; }
      if (gpsAccCircle){ map.removeLayer(gpsAccCircle); gpsAccCircle = null; }

      lastFix = null;
      $("gpsBtn").textContent = "Start GPS";
      setPill(gpsPill, false, "GPS");
      setStatus("GPS OFF.");
      showToast("GPS stopped");
    }

    function startTracking(){
      if (watchId === null){
        setStatus("Start GPS first, then start tracking.");
        showToast("Start GPS first ⚠️");
        return;
      }
      isTracking = true;
      setPill(trkPill, true, "TRACK");
      $("trackBtn").textContent = "Stop Tracking";
      $("trackBtn").classList.remove("secondary");

      ensureTrackLine();

      if (lastFix && trackPoints.length === 0){
        trackPoints.push(lastFix);
        trackLine.addLatLng([lastFix.lat, lastFix.lng]);
      }

      setStatus(`Tracking started… Points: ${trackPoints.length}`);
      showToast("Tracking started ✅");
    }

    function stopTracking(){
      isTracking = false;
      setPill(trkPill, false, "TRACK");
      $("trackBtn").textContent = "Start Tracking";
      $("trackBtn").classList.add("secondary");
      setStatus(`Tracking stopped. Points: ${trackPoints.length}`);
      showToast("Tracking stopped");
    }

    function clearAll(){
      if (isTracking) stopTracking();
      trackPoints = [];
      if (trackLine){ map.removeLayer(trackLine); trackLine = null; }
      setStatus("Cleared current track (saved sessions remain).");
      showToast("Cleared ✅");
    }

    function loadSessions(){
      try { return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
      catch { return []; }
    }
    function saveSessions(list){
      localStorage.setItem(STORE_KEY, JSON.stringify(list));
    }

    function saveCurrentSession(){
      if (trackPoints.length < 2){
        setStatus("Need at least 2 points to save. Start tracking and move.");
        showToast("Not enough points ⚠️");
        return;
      }

      let dist = 0;
      for (let i=1; i<trackPoints.length; i++){
        dist += map.distance(
          [trackPoints[i-1].lat, trackPoints[i-1].lng],
          [trackPoints[i].lat, trackPoints[i].lng]
        );
      }

      const startTs = trackPoints[0].ts;
      const endTs = trackPoints[trackPoints.length - 1].ts;

      const session = {
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2)),
        name: `Session ${new Date(startTs).toLocaleString()}`,
        createdAt: Date.now(),
        startTs, endTs,
        points: trackPoints,
        distanceM: Math.round(dist)
      };

      const sessions = loadSessions();
      sessions.unshift(session);
      saveSessions(sessions);

      setStatus(`✅ Saved: <b>${session.name}</b> • ${session.points.length} pts • ~${session.distanceM} m`);
      showToast("Saved ✅");
    }

    // Buttons
    $("testBtn").addEventListener("click", () => {
      showToast("Buttons are working ✅");
      setStatus("Test OK ✅ Overlay buttons receive taps.");
    });

    $("gpsBtn").addEventListener("click", () => watchId === null ? startGPS() : stopGPS());
    $("centerBtn").addEventListener("click", () => {
      if (lastFix) { map.setView([lastFix.lat, lastFix.lng], Math.max(map.getZoom(), 12)); showToast("Centered ✅"); }
      else { setStatus("No GPS fix yet. Start GPS first."); showToast("No fix ⚠️"); }
    });

    $("trackBtn").addEventListener("click", () => isTracking ? stopTracking() : startTracking());
    $("saveBtn").addEventListener("click", saveCurrentSession);
    $("clearBtn").addEventListener("click", clearAll);

    // Init pills
    setPill(gpsPill, false, "GPS");
    setPill(trkPill, false, "TRACK");
  </script>
</body>
</html>
