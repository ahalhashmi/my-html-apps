<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Test (iPhone)</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --ink:#eaf0ff; --muted:#b8c6e6; --bad:#ffb3b3; }
    body{ margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap{ padding:16px; max-width:820px; margin:0 auto; }
    .card{ background:var(--card); border-radius:16px; padding:14px 14px; margin:12px 0; }
    button{
      border:0; border-radius:14px; padding:12px 14px;
      font-weight:700; width:100%;
      background:#2d6cdf; color:white; font-size:16px;
    }
    button.secondary{ background:#2a2f3a; }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .k{ color:var(--muted); font-size:12px; margin-top:10px; }
    .v{ font-size:18px; margin-top:4px; word-break:break-word; }
    .bad{ color:var(--bad); }
    code{ background:#0003; padding:2px 6px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:10px 0 0;">GPS Permission + Coordinates Test</h2>

    <div class="card" id="envCard">
      <div class="k">Environment</div>
      <div class="v" id="env"></div>
      <div class="k">Status</div>
      <div class="v" id="status">Press “Get current position”.</div>
    </div>

    <div class="row">
      <button id="getBtn">Get current position</button>
      <button id="watchBtn" class="secondary">Start live watch</button>
    </div>

    <div class="card">
      <div class="k">Latitude</div><div class="v" id="lat">—</div>
      <div class="k">Longitude</div><div class="v" id="lng">—</div>
      <div class="k">Accuracy (meters)</div><div class="v" id="acc">—</div>
      <div class="k">Altitude (m)</div><div class="v" id="alt">—</div>
      <div class="k">Heading</div><div class="v" id="head">—</div>
      <div class="k">Speed (m/s)</div><div class="v" id="spd">—</div>
      <div class="k">Timestamp</div><div class="v" id="ts">—</div>
    </div>

    <div class="card">
      <div class="k">Common iPhone reasons it won’t prompt</div>
      <div class="v" style="font-size:14px; line-height:1.45; color:var(--muted);">
        1) You opened the file as <code>file://</code> (no permission prompt).<br>
        2) Page is not <b>HTTPS</b> (iOS requires secure context).<br>
        3) iPhone Settings block Safari location: <b>Settings → Privacy & Security → Location Services → Safari Websites</b>.<br>
        4) “Precise Location” off may reduce accuracy (still should show coords).
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const env = {
      protocol: location.protocol,
      host: location.host || "(no host)",
      href: location.href,
      secureContext: window.isSecureContext,
      ua: navigator.userAgent
    };

    $("env").innerHTML =
      `Protocol: <b>${env.protocol}</b><br>` +
      `Host: <b>${env.host}</b><br>` +
      `Secure context: <b>${env.secureContext}</b><br>` +
      `URL: <span style="color:#b8c6e6">${env.href}</span>`;

    function setStatus(msg, bad=false){
      $("status").innerHTML = msg;
      $("status").classList.toggle("bad", bad);
      $("envCard").style.outline = bad ? "2px solid #ffb3b366" : "none";
    }

    function fill(pos){
      const c = pos.coords;
      $("lat").textContent = (c.latitude ?? "—").toFixed ? c.latitude.toFixed(6) : c.latitude;
      $("lng").textContent = (c.longitude ?? "—").toFixed ? c.longitude.toFixed(6) : c.longitude;
      $("acc").textContent = (c.accuracy ?? "—");
      $("alt").textContent = (c.altitude ?? "—");
      $("head").textContent = (c.heading ?? "—");
      $("spd").textContent = (c.speed ?? "—");
      $("ts").textContent = new Date(pos.timestamp || Date.now()).toString();

      setStatus(`✅ Got location. Accuracy ~${Math.round(c.accuracy || 0)}m.`);
    }

    function fail(err){
      const code = err && (err.code !== undefined) ? err.code : "—";
      const msg  = err && err.message ? err.message : String(err);

      setStatus(
        `❌ GPS error (code ${code}): ${msg}<br>` +
        `If no prompt: you must serve this over <b>HTTPS</b> (or localhost) — not <code>file://</code>.`,
        true
      );
    }

    function getOnce(){
      if (!navigator.geolocation){
        setStatus("Geolocation not supported.", true);
        return;
      }
      // Hard stop if it's file:// on iOS — likely no prompt
      if (location.protocol === "file:"){
        setStatus("You opened this as <code>file://</code>. On iPhone Safari, location permission usually won’t work. Host it on HTTPS.", true);
        return;
      }
      if (!window.isSecureContext){
        setStatus("Not a secure context. Use HTTPS (or localhost). iPhone requires it for GPS.", true);
        return;
      }

      setStatus("Requesting location permission… you should see a prompt.");

      navigator.geolocation.getCurrentPosition(fill, fail, {
        enableHighAccuracy: true,
        timeout: 12000,
        maximumAge: 0
      });
    }

    let watchId = null;

    function startWatch(){
      if (!navigator.geolocation){
        setStatus("Geolocation not supported.", true);
        return;
      }
      if (location.protocol === "file:"){
        setStatus("You opened this as <code>file://</code>. Host it on HTTPS for GPS to work.", true);
        return;
      }
      if (!window.isSecureContext){
        setStatus("Not a secure context. Use HTTPS (or localhost).", true);
        return;
      }

      setStatus("Starting live watch…");
      watchId = navigator.geolocation.watchPosition(fill, fail, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 12000
      });

      $("watchBtn").textContent = "Stop live watch";
      $("watchBtn").classList.remove("secondary");
    }

    function stopWatch(){
      if (watchId !== null){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      setStatus("Live watch stopped.");
      $("watchBtn").textContent = "Start live watch";
      $("watchBtn").classList.add("secondary");
    }

    $("getBtn").addEventListener("click", getOnce);

    $("watchBtn").addEventListener("click", () => {
      if (watchId === null) startWatch();
      else stopWatch();
    });
  </script>
</body>
</html>
